## 공사중입니다.

---

## 거대한 단일 MMORPG 서버 아키텍처

https://marsettler.com

---

### 누구나 그럴싸한 계획을 가지고 있다. 얼굴에 한방 쳐맞기 전까지는.

---

### 시작하기 전에

MMORPG가 가진 게임성의 핵심은 유저간 상호작용에 있다

그리고 그 상호작용은 많으면 많을수록 좋다

---

## 거대한 단일 MMORPG 서버

---

### MMORPG를 먼저 살펴봅시다

대규모 다중 사용자 온라인 롤플레잉 게임

일반적으로 같은 지역 내에 수십에서 수백 명의 유저가 동시에 상호작용 가능한 게임을 말함

기술적 요구사항: 수십에서 수백명의 유저가 한 지역 내에서 상호작용 가능해야 함

---

### 거대한 단일 MMORPG 서버

대부분의 MMORPG는 서버의 성능 한계를 해소하기 위해, 물리적으로 분리된 여러 서버를 운영하며, 이 결과로 서로 다른 서버에서 플래이 중인 유저끼리는 게임 내에서 상호작용할 수 없습니다.

거대한 단일 MMORPG 서버는 위 제약사항이 해소되어 모든 유저가 서로 상호작용 할 수 있는 서버를 말합니다.

기술적 요구사항: 모든 유저가 상호작용가능해야 함

---

## 기획적인 제약

---

### 늘어나는 유저에 따른 인구밀도 증가는 어떻게 해결할 것인가?

1. 채널 방식
	- 다수의 게임이 쉽게 채용하고 있는 방식
	- 한 지역을 유저들이 직접 상호작용할 수 없는 여러 채널로 분리
2. 절차적 지역 생성 방식
	- 유저가 늘어남에 따라 지역을 정해진 규칙에 따라 절차적으로 생성하는 방식

---

### 이런 방식의 운영이 정말 유저에게 만족감을 줄 수 있는가?

10개의 서버였다면 1등 유저는 서버별 1명으로 10명이지만 단일 서버의 경우 1명인데, 이로 인해 유저가 상실감이나 과도한 경쟁에 노출되는 것은 아닌가?

---

### 기존의 운영 노하우를 적용할수 있는가?

신규유저과 기존유저의 격차를 좁히기 위해 신서버 오픈 등의 운영을 사용할 수 없습니다.

### 거대한 단일 MMORPG 사례
---

## 기술적인 제약

---

### MMORPG 게임서버 아키텍처

매우 단순화된 MMORPG 게임서버 아키텍처는 아래와 같습니다.

클라이언트 <-> 서버 <-> 데이터베이스

---

### 서버를 확장하고 싶을 때 고려할 수 있는 방법

- 스케일 업
- 스케일 아웃

---

### 스케일 업

단일 장비의 성능을 개선함(물리적인 한계 명확함)

---

### 스케일 아웃

여러 장비를 사용해서 처리능력을 향상시침

---

### 궁극적으로 우리는 스케일 아웃이 필요합니다.

---

### 고전적인 MMORPG에서의 스케일 아웃

고전적인 MMORPG에서 서버를 확장할 때 기존 서버와 물리적인 연결을 고려하지 않고 장비를 증설함,
이로 인해 서버간 단절이 발생

거대한 단일 MMORPG는 기존 서버와 물리적인 연결이 필요로 하기 때문에 다른 접근방법이 필요함

---

## 서버 확장

---

### HTTP 기반의 서버에서의 확장에서 얻을 수 있는 아이디어

HTTP 기반 서버는 매우 쉽게 확장할 수 있습니다. 

일반적으로 스테이트리스(상태가 없음)하기 때문에 장비만 추가하면 됨

사실 상태는 사라진게 아니라 다른 무언가에게 위힘함(데이터베이스, 캐시 등)

---

### MMORPG 서버도 스테이트리스하게 만들 순 없을까?

상태를 유지해야하는 부분이 많기 때문에 쉽지 않음

매 틱마다 보스의 HP를 데이터베이스에서 가져오면 데이터베이스가 힘들어함

---

### 그러면 상태가 필요한 부분과 그렇지 않은 부분을 분리하면 어떨까?

정확하게는 상태가 많이 변경되는 부분과 간혹 변경되는 부분

---

상태가 필요한 부분: ?

아직 잘 모르겠음

---

상태가 필요하지 않은(많이 변경되지 않는) 부분을 먼저 알아봅시다.

나의 모든 아이템 목록, 나의 모든 퀘스트 목록 ...

---

상태가 필요한 부분(많이 변경되는 부분)

캐릭터 이름, 현재 HP, 지역 내에서 이동중인 발사체 ...

---

### 왠지 지역과 관련된 부분과 그렇지 않은 부분으로 나누면 될 것 같음

게임에 접속했을 때 눈에 바로 보이는 부분(현재 칭호, PK 상태, ...)또는 상태를 유지하는 것이 좋을 것 같음

개발중인 게임의 특성에 따라 많이 달라집니다.

---

### 그럼 스테이이트풀한 부분(지역)은 어떻게 관리할 것인가

지역이 다르면 물리적으로 분산된 장비에서 동작하게 구현
예를 들면 지구 지역은 서버1에서, 화성 지역은 서버2에서 동작하게 구현

---

### 구현 시 고민해 봐야할 것들

지구 지역에서 화성 지역으로의 이동은 어떻게 처리할 것인가?

게임의 특성에 따라 달라지지만 아래 두가지 선택지 중 하나를 선택해야 함

1. 한 유저가 동시에 두 지역에 있는 것을 허용
2. 특정 서버가 다운되면 다운된 서버에 같힌 유저는 모든 서버에 접속 불가

---

## 데이터베이스 확장

이미 많은 연구가 진행됨 부분입니다. 서버와 마찬가지로 데이터베이스도 단일 장비의 물리적인 한계를 겪었습니다.

---

### 지금까지 많이 사용되는 옵션은 크게 두 가지가 있습니다.

1. 서버 프로그래머가 직접 처리
2. NoSQL 사용

---

## 서버가 데이터베이스에 접근할 때 잘 처리한다

---

### 대표적으로 샤딩을 살펴봅시다

샤딩은 같은 테이블 스키마를 가진 데이터를 다수의 데이터베이스에 분산하여 저장하는 방법을 말합니다

---

### 어떤 고려사항이 있을까요?

- 특정 유저의 데이터는 어떤 데이터베이스에 저장해야 할까요?
- 데이터를 적절히 분산해야 특정 데이터베이스에 부하가 몰리지 않을텐데 어떻게 해야 할까요?
- 등등...

---

### 스케일아웃의 경우 범용적인 해법이 어느정도 정해져 있습니다

스케일 인이 필요해졌을 때는 어떻게 할까요?<span class="fragment">(빠르게 도주합니다.)</span>

---

### 분산 트랜잭션

트랜잭션은 논리적 단위작업을 말하며, 일반적인 관계형 데이터베이스는 ACID 트랜잭션을 제공합니다.

Atomicity
Consistency
Isolation
Durability

하지만 2개 이상의 물리장비로 분산된 환경에서는 서버에서 트랜잭션을 구현해야 함

---

### 유저간 거래

예를 들어보겠습니다

1. A 유저 아이템 지급 <span class="fragment">(여기에서 서버가 다운된다면?)</span>
2. B 유저 아이템 제거
3. A 유저 돈 감소
4. B 유저 돈 증가

---

### 이런 방법은 어떨까요?

개념은 다음과 같습니다

1. BEGIN: 작업시작
2. END: 작업종료
3. PREPARE: 준비(만약 준비가 실패하면 모든 작업을 작업시작 전으로 돌림)
4. COMMIT: 커밋

---

### 실제로 보죠

1. BEGIN
	- A 유저 아이템 지급하고 비활성화
	- A 유저 아이템 활성화 로그 추가
	- B 유저 아이템 비활성화
	- B 유저 아이템 삭제 로그 추가
	- A 유저 돈 감소용 로그 추가
	- B 유저 돈 증가용 로그 추가
2. END
3. PREPARE
	- 로그가 정상적으로 기록되었는지 확인
4. COMMIT
	- 관련 데이터를 락하고 적용
	- 중도에 실패시 로그 기반으로 모두 롤백

### 동작할까요?

대략적인 원리는 동일하시만 실서비스에는 더 많은 예외상황이 있을 겁니다

---

### NoSQL을 사용

NoSQL을 한 마디로 정의하긴 어렵지만 전통적인 관계형 데이터베이스가 제공하던 몇 가지 기능을 희생하는 대신 수평 확장을 이루어낸 데이터베이스입니다.

---

### NoSQL이 희생한 기능 중 대표적인 기능은 일관성

이들은 일관성을 희생하며 대신 이벤츄얼 컨시스턴시를 제공합니다.

---

### 한국어로는 최종 일관성이나, 궁극적 일관성으로 불리기도 함

뭔가 멋져보이는 이름이지만 프로그래머 잡는 동작방식

---

### 극단적인 예

0. 최도 보유 골드 1000
1-1. 1번 서버에서 사냥으로 골드 100을 획득 1100
1-2. 2번 서버의 유저에게서 100원짜리 검 구매 900
2. 음?

이처럼 단순한 예 정도는 프로그래머가 통제할 수 있겠지만 MMORPG는 매우 다양한 컨텐츠를 가지고 있음

---

### 이벤츄얼 컨시스턴시?

https://www.reddit.com/r/Database/comments/avz1xk/eventual_consistency/

---

### 데이터베이스 확장에서의 문제점

기존의 RDBMS가 제공하던 일관성, 트랜잭션, SQL 등의 부분을 지원하지 않아,
결과적으로 서버 개발자에게 너무 큰 부담을 줌

---

### 지금까지의 문제를 모두 해결해야 합니다.

### 누가? 프로그래머가? 그러면 기능은 누가 만들죠?

---

### 그러면 해법은 어디 있을까요?

---

### 카크로치디비!

오픈소스로 작성된, 클라우드 기반의 SQL 데이터베이스

스케일 아웃, 고가용성, ACID 트랜잭션으로 포함되는 강한 일관성, SQL API를 제공합니다.

https://github.com/cockroachdb/cockroach

---

### NewSQL이라고 불리는 함께 불리는 비슷한 특징을 가진 데이터베이스가 여러 개 있습니다

선택은 당신의 몫입니다. NoSQL이라고 불리는 데이터베이스들이 얼마나 서로 다른지 생각해보십시오.

---

### 거대한 단일 MMORPG 서버 아키텍처

정의 -> 기획적인 제약 -> 기술적인 제약 -> 서버 확장 -> 데이터베이스 확장

---

###

정의:
	- 모든 유저가 결국에는 상호작용 가능하여야 함
기획적인 제약: 생각보다 문제가 많다. 우리 게임이 정말 원하는 목표인지 고민해보자
기술적인 제약:
	서버는 상태를 가진 부분과 아닌 부분을 나누어서 확장
	데이터베이스는 NewSQL을 도입해보자

---

### 누구나 그럴싸한 계획을 가지고 있다. 얼굴에 한방 쳐맞기 전까지는.

---

## 감사합니다.

https://marsettler.com
